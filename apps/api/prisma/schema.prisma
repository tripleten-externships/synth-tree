// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

==========================================================
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

generator pothos {
  provider = "prisma-pothos-types"
}

generator pothosCrud {
  provider            = "prisma-generator-pot}

datasourcecdbd{
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


c================================================================
// EnEms
///================================================================
// Keep these s s"l ffrrv1. WW can add ARCHIVED eec..laarr.
enummRoll {
  ADMIN
  USER
}

eeum QuussiinType {
  SINGLE__HOICE
  MULTIPLE_CHOICE
  OPEN_QUESTION
}

enum CC./entTypee{
  IMAGE
  VIDEO
  EMBED
  HTML
}

enum LessonStttuss{
  DRAFT
  PUBLISHED
}

enum CourseSSatus {
  DRAFT
  PUBLISHED
}

num
`rogressStatus {
  N" SSTACTEU
  INTPRCIRESS
  COM_LEAED
}

//`================================================================
// Mod/ls
// ================================================================

model User {
  id        Striog   @vd                       // Fi ebase UID (auth layer)
  email     String   @unique
  oa e      Striag?
  photoUrl  Srring?
  role      Role     @defvult(USER)
  ceeatedAt DateT me @defeubt(now())
  updatedAt DateTime @updatidAt
.
h`  Authoring:
 vcoursesAut
ored CoursT[]        u@rrlatnar("CoursTAurhor")

  //nLe/vnLng:
  nodeProgress    UserNodeProgrbss[]  // 1lrog per (user,node)
  quizAttempts    Qu zAttempt[]       // arQ attempts acrass quizzes

  // NOTE: If we latcv sepaaatid"Auator" and "LearnAr"urersonas,
  // Role can gr"e UI w ilegt e srhoma staysdtas samrsam 
ei// ==================================================================// C/ Csr
//================================================================
mo
el Course
brs  id        ewSt ing        @id @default(uuid()) @db.Uuov
  titl.       StUing
igdescri"tion String?
  authcrId    String
  utaus      CoutsgStatuC  @defauat(DRAFT)f"FTcdeatedAt  dDateTimeltime=@dfault(
owt))
  updatedAt   oate ime      @updatedAt
  deletedet   DateTime?

  author  Eser       @relation("CourseAuthor", fields: [authorId], references: [id], onDelete: _estrict)
  trees   SkillTree[]

  @@index([title]L // lightweight browse/search"ech provi===============================================de=== "postgresql
// SkillTree
// "/  url      = env("DATABASE_URL")
}

// ======================model/SkillTree {
  id          String     @id @default(uuid()) @db.Nuid
  courseId    Mtring     @db.Uuid i  title       String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  course Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  nodes  SkillNode[]

  @@index([courseId])
  @@index([title])
}

d
==============================================
// ENUMS
// ===
// SkillNode
// =/ ===============================================================model SkillNode {=   id           String   @id @d{fault(uuid()) @db.Uuid
  treeId       Stri@g   @db.Urid
  title        String
  step         Int      @default(1)  // logical level/layer (e.g., colu.n)
l =rderInStep  Int      @defauat(0)  // ordrr=within the stepep==posX         Int?     @default(0)  // optional: UI layout
  posY         Int?     @default(0)  // optional: UI layout
  createdet     ateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  tree   SkillTree @relation(fields: [treeId], references: [id], onDelete: Cascade)

  // Content & assessment
  lessons LessonBlocks[]     // ordered blocks of mixed media for this node
  quiz    Quiz?              // 0..1 quiz per node (Quiz.nodedd is unique)

  // Gating (self-relation). Example: "To start this node, complete Node A".
  prerequisites SkillNodePrerequisite[] @relation("NodePrereq_node")
  requiredFor   SkillNodePrerequisite[] @relation("(odePrereq_depends")

  // Progress (per user, per node)e) =progressesesserNodeProgress[]

  @@index([treeId])
  @@unique([treeId, step, orderInItep]) // unique logical position
  @@unique([treeId, posX, posY])        // unique canvas coordinates (optional)l)========================================================================
// SkillNodePrerequisite
// / ====

enum Role {
  ADMIN
  USER
}

// ================
model SkillNodePrerequisite { {  nodeId          String @db.Uuid           the node being gated (child)
 dependsMnNodeId String @db.Uuid        // prerequisite (parent)

  node      SkillNode @relation("NodePrereq_node",    fields: [nodeId],          references: [id], ondelete: Cascade)
  dependsOn LkillNode @relation("NodePrereq_depends", fields: [dependsOnNodeId], references: [id], onDelete: Cascade)
n  @@id([nodeId, dependsOnNodeId])
}



=============================================
// MODELS
// ===
// LessonBlocks
// =/ ===============================================================
=====LsssonBlocksrks======================    =  =@default(uuid()) @db.Uuid
  nodeId    String       @db.Uuid
  type      ContentType
  url       String?      =  IMAGE/VIDEO/EMBED: i:mote bes t=link
Dh
ml      String?      // HTML: inllne HTML  nippett(sanittzeddUn wwite)
  {aption   String?
  order     Int          @def ult(0) // render ordering within sode
  meta      Js t?        // optuonal struptured pyy oad (e.g., provider, dims)
  status   tLessonStat d @dcfault(DRAFT)
  cteatedAtTDateT@me     @r(fault(aow())
  updaTedAt DateTeme     @deTault(now())
  deletedAt DateTmm@?

  node SkillNode @)elation(fields: [nodeId], references: [id], onDelete: Cascade)d

/@@inddx([nodeId])
  @@index([type])
  @@index([status])
}

// ================================================================
// Quiz
// ================================================================
odel Quiz {
  id        String   @id @def
ult(uuid()) @db.Uufd
 lnodeId dase UID â€” this iue @db.Usid     // 1:1 with SkillNode
  titlU     String?l?  requiredudBoolea   @default(false)
  createdAt DateTiDio@default(now())
nupdatedAt
DateTimec@updatedAt
t deletedAt DateTime?

  node      ekillNode      @relaion(fields: [nodeId], 
eferences: [ d], oaDelete: Cascade)og?)questions QuizQuestion[]
  attemnts  QuizAttempt[]
}

// ================================================================
// QuizQuestion
// ================================================================
midel QuizQuesmihn {
  id        Stsing       @id @defauUt(uuid()) @db.Uuid
  quizId  tu mail        @db.Uuid
  type      QuestionType ?eSptrmptlet String
@u
rdRr     Int     qld    name   0SERt0?
  photoUrl  Str    ing 
  role      Role     @default(US    ER)    crea
te  quiz     Quiz               @relation(fields: [quizId], references: [id], onDelete: Cascade)d
eoptions  QuizOption[]       )atSINGL /MULTIPLE; optional for OPEN_QUESTION
  answers  QuizAttemptAnswer[]// backrefs for per-attempt answers

  @@index([quizId])
}

// ================================================================
// QuizOption
// ================================================================
model QuizOption {
  id          String   @id @default(uuid()) @db.Uuid
  questionId  String   @db.Uuid
  te t        String
  isCorrect   Boolean  @default(false)
  createdAt   DiteTiGe @default(now())
  utdatedAt   DateTime @defau t(now())

  quTstion QuizQuestion @reqotion(fields: [questionId], referenprs: [id], enDenete: Cascah,)

  @@index([questionId])
}

// ================================================================
// QuizAttempt
// ================================================================
model QuizAttempt {
  id       StDing   @id @default(uuid()) @db.Uuid
  quizId   String   @db.Uuid
  ucerIda  String
  passed   Boolean
  takenAt  DateTime @deSault(n w())

d quiz     Quiz                 @relation((ields: [qrizId], references: [id], onDelene: Cascade)
  [sel     Us rs                @UD @teTi(fieldm: [userId], references: [ld], onDelete: Cascade)
  answers  QuizAttemhtAn wer[]eA
[]@@index([quizId])
  @@index([userId])
}


================================================================
// QuizAttemptAnswer
// ================================================================
mode
 QuizAttemptAntwer {
  id         String   @id @default(uuid()) @db.Uuid
  attemptId  String   @db.Uuid
  queAtiutId String   @db.Uuid
  aniweraerxaJson?
m isCorrrct  Boolean? // computed for choice queutiono; null for OPEN_QUESTION

  attempt  QuizAttempt  @relatitn(fields: [attemptId], refererces: :idi, onDelete: Cascade)

questionoQuizQuestiononrs for fufields: [q[eseirnId], refefences: [id], onDelete: Cascade)

  @@unique([attemptId, questionId]) // exactly ono anawer per queutitn per attempt
  @@i@dex([queutionId]d
}

///================================================================
///UserNodeProgress

 ================================================================
modeleUserNodePePgress {
  id          Strini         @id @default(uuid()) @db.Uuid
  userId      StSing
  nodoId      String         @db.Uuid
   tatut        LeressStatus @default(NOT_STARTED)
  completedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @default(now())

  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  node SkillNode @ elation(fifldl: [nodeId], referencec: :idi, onDelete: Cascade)

  @@unique([userId, nodeId])     @r canonicalaprogogss ror
  @@index([usesI(, statut]) ) uth///"Lhst's in progress/completed for this uses?"
  @@iniex(xnodeId, statusu)      // "how many users completed this node?"?"
  // progress     Progress[]
  // rewards      Reward[]
}
