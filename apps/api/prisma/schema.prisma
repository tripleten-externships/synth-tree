// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

generator pothos {
  provider = "prisma-pothos-types"
}

generator pothosCrud {
  provider            = "prisma-generator-pothos-codegen"
  generatorConfigPath = "./pothos.config.js"
  // You may also set the `generatorConfigPath` via the `POTHOS_CRUD_CONFIG_PATH` environment variable.
  // The environment variable will override the path hardcoded here.
}

// Refer to branch: ST-13-design-minimal-viable-database-schema for more in-depth information
// The ST-13 branch database-schema.md document also has a show case for using the prisma orm and these models.
// Rewards and Gamification intentionally not implemented yet.
// Leaving comments in the schema file. Request removal if the team does not want this.

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  OPEN_QUESTION
}

enum ContentType {
  IMAGE
  VIDEO
  EMBED
  HTML
}

enum LessonStatus {
  DRAFT
  PUBLISHED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model User {
  id        String   @id
  email     String   @unique
  name      String?
  photoUrl  String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Authoring:
  coursesAuthored Course[] @relation("CourseAuthor")

  // Learning:
  nodeProgress UserNodeProgress[] // 1 row per (user,node)
  quizAttempts QuizAttempt[]      // all attempts across quizzes

  // NOTE: If we later separate "Author" and "Learner" personas,
  // Role can gate UI while the schema stays the same.
}

// ================================================================
// Course
// - Author-owned content container for one or more SkillTrees.
// - Soft delete included to allow recoverability.
// ================================================================
model Course {
  id          String        @id @default(uuid()) @db.Uuid
  title       String
  description String?
  authorId    String
  status      CourseStatus  @default(DRAFT)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?

  author User      @relation("CourseAuthor", fields: [authorId], references: [id], onDelete: Restrict)
  trees  SkillTree[]

  @@index([title])
}

// ================================================================
// SkillTree
// - A course may have >1 tree; most courses likely use just one.
// - Deleting a tree cascades to nodes and their content/quiz data.
// ================================================================
model SkillTree {
  id          String     @id @default(uuid()) @db.Uuid
  courseId    String     @db.Uuid
  title       String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?

  course Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  nodes  SkillNode[]

  @@index([courseId])
  @@index([title])
}

// ================================================================
// SkillNode
// - A single learning step in a tree.
// - Two orderings:
//   1) Logical order: (step, orderInStep) used for gating.
//   2) Visual layout: (posX, posY) for the editor canvas.
// - Exactly one (optional) Quiz per node (enforced on Quiz.nodeId).
// ================================================================
model SkillNode {
  id           String   @id @default(uuid()) @db.Uuid
  treeId       String   @db.Uuid
  title        String
  step         Int      @default(1)
  orderInStep  Int      @default(0)
  posX         Int?     @default(0)
  posY         Int?     @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  tree SkillTree @relation(fields: [treeId], references: [id], onDelete: Cascade)

  lessons LessonBlocks[] // ordered content blocks
  quiz    Quiz?          // optional 1:1

  prerequisites SkillNodePrerequisite[] @relation("NodePrereq_node")
  requiredFor   SkillNodePrerequisite[] @relation("NodePrereq_depends")

  progresses UserNodeProgress[]

  @@index([treeId])
  @@unique([treeId, step, orderInStep])
  @@unique([treeId, posX, posY])
}

// ================================================================
// SkillNodePrerequisite
// ================================================================
model SkillNodePrerequisite {
  nodeId          String @db.Uuid
  dependsOnNodeId String @db.Uuid

  node      SkillNode @relation("NodePrereq_node", fields: [nodeId], references: [id], onDelete: Cascade)
  dependsOn SkillNode @relation("NodePrereq_depends", fields: [dependsOnNodeId], references: [id], onDelete: Cascade)

  @@id([nodeId, dependsOnNodeId])
}

// ================================================================
// LessonBlocks
// ================================================================
model LessonBlocks {
  id        String       @id @default(uuid()) @db.Uuid
  nodeId    String       @db.Uuid
  type      ContentType
  url       String?
  html      String?
  caption   String?
  order     Int          @default(0)
  meta      Json?
  status    LessonStatus @default(DRAFT)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  node SkillNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@index([nodeId])
  @@index([type])
  @@index([status])
}

// ================================================================
// Quiz
// ================================================================
model Quiz {
  id        String   @id @default(uuid()) @db.Uuid
  nodeId    String   @unique @db.Uuid
  title     String?
  required  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  node      SkillNode      @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  attempts  QuizAttempt[]
}

// ================================================================
// QuizQuestion
// ================================================================
model QuizQuestion {
  id        String       @id @default(uuid()) @db.Uuid
  quizId    String       @db.Uuid
  type      QuestionType
  prompt    String
  order     Int          @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  quiz     Quiz               @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options  QuizOption[]
  answers  QuizAttemptAnswer[]

  @@index([quizId])
}

// ================================================================
// QuizOption
// ================================================================
model QuizOption {
  id          String   @id @default(uuid()) @db.Uuid
  questionId  String   @db.Uuid
  text        String
  isCorrect   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

// ================================================================
// QuizAttempt
// ================================================================
model QuizAttempt {
  id      String   @id @default(uuid()) @db.Uuid
  quizId  String   @db.Uuid
  userId  String
  passed  Boolean
  takenAt DateTime @default(now())

  quiz    Quiz                 @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user    User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers QuizAttemptAnswer[]

  @@index([quizId])
  @@index([userId])
}

// ================================================================
// QuizAttemptAnswer
// ================================================================
model QuizAttemptAnswer {
  id         String   @id @default(uuid()) @db.Uuid
  attemptId  String   @db.Uuid
  questionId String   @db.Uuid
  answer     Json?
  isCorrect  Boolean?

  attempt  QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([questionId])
}

// ================================================================
// UserNodeProgress
// ================================================================
model UserNodeProgress {
  id          String         @id @default(uuid()) @db.Uuid
  userId      String
  nodeId      String         @db.Uuid
  status      ProgressStatus @default(NOT_STARTED)
  completedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  node SkillNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([userId, nodeId])
  @@index([userId, status])
  @@index([nodeId, status])
}
