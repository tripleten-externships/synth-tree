name: PR Validation

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  NODE_VERSION: "24"
  PNPM_VERSION: "10"

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      api: ${{ steps.filter.outputs.api }}
      frontend: ${{ steps.filter.outputs.frontend }}
      ui: ${{ steps.filter.outputs.ui }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra:
              - 'apps/infra/**'
            api:
              - 'apps/api/**'
              - 'packages/api-types/**'
            frontend:
              - 'apps/admin-dashboard/**'
              - 'packages/**'
            ui:
              - 'packages/ui/**'
              - 'packages/theme/**'

  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: |
          echo "Running ESLint..."
          pnpm run lint
          echo "✅ Linting complete"

      - name: Run TypeScript type check
        run: |
          echo "Running TypeScript type check..."
          pnpm run type-check
          echo "✅ Type check complete"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: infra
            name: apps/infra
            filter: ./apps/infra
          - id: api
            name: apps/api
            filter: ./apps/api
          - id: admin-dashboard
            name: apps/admin-dashboard
            filter: ./apps/admin-dashboard
          - id: client-frontend
            name: apps/client-frontend
            filter: ./apps/client-frontend
          - id: ui
            name: packages/ui
            filter: ./packages/ui
          - id: theme
            name: packages/theme
            filter: ./packages/theme
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests (infra)
        if: matrix.id == 'infra'
        working-directory: apps/infra
        run: pnpm exec jest --ci --coverage --json --outputFile=coverage/test-results.json --passWithNoTests

      - name: Run unit tests (vitest)
        if: matrix.id == 'api' || matrix.id == 'admin-dashboard' || matrix.id == 'client-frontend' || matrix.id == 'ui'
        run: pnpm --filter ${{ matrix.filter }} exec vitest run --coverage --reporter=default --reporter=junit --outputFile=coverage/junit.xml --passWithNoTests

      - name: Run unit tests (non-vitest)
        if: matrix.id == 'theme'
        run: pnpm --filter ${{ matrix.filter }} run test:unit --if-present

      - name: Publish unit test results (vitest)
        if: always() && (matrix.id == 'api' || matrix.id == 'admin-dashboard' || matrix.id == 'client-frontend' || matrix.id == 'ui')
        uses: dorny/test-reporter@v1
        with:
          name: Unit Tests (${{ matrix.name }})
          path: ${{ matrix.name }}/coverage/junit.xml
          reporter: java-junit

      - name: Publish test summary
        if: always() && matrix.id == 'infra'
        run: |
          node <<'NODE'
          const fs = require('fs');

          const summary = process.env.GITHUB_STEP_SUMMARY;
          const lines = [];
          const resultsPath = 'apps/infra/coverage/test-results.json';

          if (fs.existsSync(resultsPath)) {
            const data = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            const total = data.numTotalTests ?? 0;
            const passed = data.numPassedTests ?? 0;
            const failed = data.numFailedTests ?? 0;
            const skipped = data.numPendingTests ?? 0;
            lines.push(
              'Unit Tests (infra): total ' + total + ', passed ' + passed + ', failed ' + failed + ', skipped ' + skipped
            );
          } else {
            lines.push('Unit Tests (infra): no test results found');
          }

          const coveragePath = 'apps/infra/coverage/coverage-summary.json';

          if (fs.existsSync(coveragePath)) {
            const cov = JSON.parse(fs.readFileSync(coveragePath, 'utf8')).total || {};
            const pct = (value) => (typeof value === 'number' ? value + '%' : 'n/a');
            lines.push(
              'Coverage (infra): lines ' + pct(cov.lines?.pct) + ', statements ' + pct(cov.statements?.pct) +
                ', functions ' + pct(cov.functions?.pct) + ', branches ' + pct(cov.branches?.pct)
            );
          } else {
            lines.push('Coverage (infra): no coverage summary found');
          }

          fs.appendFileSync(summary, lines.join('\n') + '\n');
          NODE

      - name: Upload coverage to Codecov
        if: ${{ env.CODECOV_TOKEN != '' && matrix.id != 'theme' }}
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        uses: codecov/codecov-action@v4
        with:
          token: ${{ env.CODECOV_TOKEN }}
          files: ${{ matrix.name }}/coverage/lcov.info
          flags: ${{ matrix.id }}
          name: ${{ matrix.id }}-coverage
          fail_ci_if_error: true

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: api
            name: apps/api
            filter: ./apps/api
          - id: infra
            name: apps/infra
            filter: ./apps/infra
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start test database
        if: matrix.id == 'api'
        run: pnpm db:start

      - name: Run integration tests (api)
        if: matrix.id == 'api'
        run: pnpm --filter ./apps/api exec vitest run --config vitest.integration.config.ts --reporter=default --reporter=junit --outputFile=coverage/integration-junit.xml --passWithNoTests

      - name: Run integration tests (infra)
        if: matrix.id == 'infra'
        run: pnpm --filter ${{ matrix.filter }} run test:integration --if-present

      - name: Publish integration test results
        if: always() && matrix.id == 'api'
        uses: dorny/test-reporter@v1
        with:
          name: Integration Tests (apps/api)
          path: apps/api/coverage/integration-junit.xml
          reporter: java-junit

      - name: Stop test database
        if: always() && matrix.id == 'api'
        run: pnpm db:stop

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.api == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (validation only)
        run: |
          echo "Building API Docker image..."
          docker buildx build \
            --platform linux/amd64 \
            --file apps/api/Dockerfile \
            --tag api:pr-${{ github.event.pull_request.number }} \
            --load \
            .

          echo "✅ Docker build successful"

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build theme library
        working-directory: packages/theme
        run: pnpm build

      - name: Build component library
        working-directory: packages/ui
        run: pnpm build

      - name: Build frontend
        working-directory: apps/admin-dashboard
        env:
          VITE_API_URL: https://api.dev.synth-tree.com
          VITE_ENVIRONMENT: dev
        run: |
          echo "Building frontend..."
          pnpm build

          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo "❌ Build failed"
            exit 1
          fi

          echo "✅ Frontend build successful"

      - name: Check bundle size
        working-directory: apps/admin-dashboard
        run: |
          echo "Checking bundle size..."
          BUNDLE_SIZE=$(du -sh dist | cut -f1)
          echo "Bundle size: $BUNDLE_SIZE"

  build-storybook:
    name: Build Storybook
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.ui == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build theme library
        working-directory: packages/theme
        run: pnpm build

      - name: Build component library
        working-directory: packages/ui
        run: pnpm build

      - name: Build Storybook
        working-directory: packages/ui
        run: |
          echo "Building Storybook..."
          pnpm build-storybook

          if [ ! -d "storybook-static" ] || [ -z "$(ls -A storybook-static)" ]; then
            echo "❌ Build failed"
            exit 1
          fi

          echo "✅ Storybook build successful"

  summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs:
      - lint-and-typecheck
      - unit-tests
      - integration-tests
      - build-api
      - build-frontend
      - build-storybook
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Lint & Type Check: ${{ needs['lint-and-typecheck'].result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs['unit-tests'].result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs['integration-tests'].result }}" >> $GITHUB_STEP_SUMMARY
          echo "- API Build: ${{ needs['build-api'].result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Build: ${{ needs['build-frontend'].result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Storybook Build: ${{ needs['build-storybook'].result }}" >> $GITHUB_STEP_SUMMARY

          # Check if any job failed
          if [[ "${{ needs['lint-and-typecheck'].result }}" == "failure" ]] || \
             [[ "${{ needs['unit-tests'].result }}" == "failure" ]] || \
             [[ "${{ needs['integration-tests'].result }}" == "failure" ]] || \
             [[ "${{ needs['build-api'].result }}" == "failure" ]] || \
             [[ "${{ needs['build-frontend'].result }}" == "failure" ]] || \
             [[ "${{ needs['build-storybook'].result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ Some validation checks failed. Please review the errors above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All validation checks passed!" >> $GITHUB_STEP_SUMMARY
          fi
